<!doctype html> 
<html lang="en"> 
<head> 
	<meta charset="UTF-8" />
    <title>Phaser - Making your first game, part 9</title>
	<script type="text/javascript" src="phaser-ce-2.8.6/build/phaser.min.js"></script>
	<script type="text/javascript" src="main.js"></script>
	<script type="text/javascript" src="ship.js"></script>
    <style type="text/css">
        body {
            margin: 0;
        }
    </style>
</head>
<body>

<script type="text/javascript">

var game = new Phaser.Game(800, 600, Phaser.AUTO, '', { preload: preload, create: create, update: update });

function preload() {
	//load art assets
    game.load.image('background', 'assets/background.png');
	game.load.image('ship','assets/OG_Ship.png');		// Ship and other art are far too large, draw by myself then
	game.load.image('Asteroid','assets/OG_Asteroid.png');
	game.load.image('bullet','assets/bullet.png');
	game.load.image('ufo','assets/OG_UFO.png');
	
}
var ship;
var UFOs;
var Asteroids;
var Asteroids_2;
var Bullets;
var scoreText;
var shipVelX;
var shipVelY;
var score = 0;

var shipCollisionGroup
var asternoidCollisionGroup
var bulletCollisionGroup
var ufoCollisionGroup
var asternoidCollisionGroup_2

function create() {
	//basic initiation
	game.add.image(0,0,'background');//add background
	game.physics.startSystem(Phaser.Physics.P2JS); //Detailed physic system
	game.physics.p2.setImpactEvents(true);// need this line to make score happen
    //game.physics.p2.restitution = 0.0;

	shipCollisionGroup = game.physics.p2.createCollisionGroup();
	asternoidCollisionGroup = game.physics.p2.createCollisionGroup();
	bulletCollisionGroup = game.physics.p2.createCollisionGroup();
	ufoCollisionGroup = game.physics.p2.createCollisionGroup();
	//game.physics.p2.updateBoundsCollisionGroup();
	//create text
	scoreText = game.add.text(game.world.centerX, game.world.centerY, "Score is " + score, { 
		font: "65px Arial", 
		fill: "#ff0044", 
		align: "center" });
    scoreText.anchor.setTo(0.5, 0.5);
	
	// create ship
	ship = game.add.sprite(game.world.width/2,game.world.height/2,'ship');
	ship.scale.set(0.1);
	game.physics.p2.enable(ship,false);
	ship.body.setCollisionGroup(shipCollisionGroup);
	shipVelX = 0.0;
	shipVelY = 0.0;
	//create asteroid
	Asteroids = game.add.group(); //commented for testing
	Asteroids.enableBody = true;
    Asteroids.physicsBodyType = Phaser.Physics.P2JS;
	var singleAsteroid = Asteroids.create(200,25,'Asteroid');
	singleAsteroid.body.velocity.x = 30;
	singleAsteroid.body.velocity.y = 30;
	
	singleAsteroid = Asteroids.create(600,25,'Asteroid');
	singleAsteroid.body.velocity.x = -30;
	singleAsteroid.body.velocity.y = 30;
	
	singleAsteroid = Asteroids.create(200,520,'Asteroid');
	singleAsteroid.body.velocity.x = 30;
	singleAsteroid.body.velocity.y = -30;
	
	singleAsteroid = Asteroids.create(500,550,'Asteroid');
	singleAsteroid.body.velocity.x = -30;
	singleAsteroid.body.velocity.y = -30;
	
	Asteroids.forEach(function(singleAsteroid){
		singleAsteroid.scale.setTo(0.2,0.2);
		singleAsteroid.body.setRectangle(40,40);
		singleAsteroid.body.setCollisionGroup(asternoidCollisionGroup);
		singleAsteroid.body.collides([shipCollisionGroup,asternoidCollisionGroup,ufoCollisionGroup]);
		singleAsteroid.body.rotateLeft(game.rnd.integerInRange(100, 200));
		singleAsteroid.body.damping = 0.0;
	});
	
	//Create UFOs
	UFOs = game.add.group(); //commented for testing
	UFOs.enableBody = true;
    UFOs.physicsBodyType = Phaser.Physics.P2JS;
	
	var singleUFO = UFOs.create(200,25,'ufo');
	singleUFO.scale.setTo(0.1,0.1);
	singleUFO.visible = false;
	singleUFO.body.setRectangle(40,40);
	singleUFO.body.setCollisionGroup(ufoCollisionGroup);
	singleUFO.body.collides([shipCollisionGroup,asternoidCollisionGroup,ufoCollisionGroup]);
	singleUFO.body.rotateLeft(game.rnd.integerInRange(100, 200));
	singleUFO.body.damping = 0.0;
	singleUFO.body.velocity.x = 30;
	singleUFO.body.velocity.y = 30;
	
	/*
	for (var i = 1; i < 10; i++) {
		var singleAsteroid = Asteroids.create(game.world.randomX, game.world.randomY,'Asteroid');
		singleAsteroid.scale.setTo(0.1,0.1);
		singleAsteroid.body.setRectangle(40,40);
		singleAsteroid.body.setCollisionGroup(asternoidCollisionGroup);
		singleAsteroid.body.collides([shipCollisionGroup,asternoidCollisionGroup]);
	}
	Asteroids.forEach( function (singleAsteroid){
		singleAsteroid.body.rotateLeft(game.rnd.integerInRange(100, 200));
		singleAsteroid.body.thrust(game.rnd.integerInRange(5000, 9000));
	});*/
	/*create bullet
	Bullets = game.add.group();//There are multiple bullets they should be created in update rather then here
	var singleBullet = Bullets.create(100,5,'bullet');
	game.physics.p2.enable(singleBullet);
	*/
	//get game input
	game.time.events.add(Phaser.Timer.SECOND*10, function(){
		singleUFO.visible = true;
	}, this);
	ship.body.collides(asternoidCollisionGroup,updateScore, this);
	ship.body.collides(ufoCollisionGroup,null, this);
	cursors = game.input.keyboard.createCursorKeys();
}	

function update() {
	ship.body.setZeroVelocity();
	ship.body.angularVelocity = 0;
		
	ship.body.x = ship.body.x + shipVelX;
	ship.body.y = ship.body.y + shipVelY;
	
	Asteroids.forEach( function (singleAsteroid){
		singleAsteroid.body.thrust(100);
		if(singleAsteroid.body.x > 800){
			singleAsteroid.body.x = 0;
		}else if(singleAsteroid.body.x < 0){
			singleAsteroid.body.x = 800;
		}
		if(singleAsteroid.body.y > 600){
			singleAsteroid.body.y = 0;
		}else if(singleAsteroid.body.y < 0){
			singleAsteroid.body.y = 600;
		}
	});
	
   
    if (cursors.left.isDown)
    {
		//updateScore(100);
		ship.body.rotateLeft(100);
    }
    else if (cursors.right.isDown)
    {
		ship.body.rotateRight(100);
    }

    if (cursors.up.isDown)
    {
    	//ship.body.moveUp(400);
		if (shipVelX*shipVelX + shipVelY*shipVelY < 8*3) {
			shipVelX += 0.05*Math.cos(ship.body.rotation);
			shipVelY += 0.05*Math.sin(ship.body.rotation);
		}
    }
	else{
		shipVelX = shipVelX*0.95;
		shipVelY = shipVelY*0.95;
	}
	
	if(ship.body.x > 800){
		ship.body.x = 0;
	}else if(ship.body.x < 0){
		ship.body.x = 800;
	}
	if(ship.body.y > 600){
		ship.body.y = 0;
	}else if(ship.body.y < 0){
		ship.body.y = 600;
	}
}
function render(){
	game.debug.text('velocity' + shipVelX +'and'+ shipVelY , 32, 200);
	game.debug.spriteInfo(ship, 32, 32);
	}
	
function updateScore(body1,body2){	// call this function to add score 
	score = score + 10;
	scoreText.setText("Score is " + score);
	
	/*var singleAsteroid = Asteroids.create(body2.sprite.x,body2.sprite.y,'Asteroid');
	singleAsteroid.body.rotation = body2.sprite.rotation;
	singleAsteroid.body.velocity = body2.sprite.velocity;
	singleAsteroid.scale.setTo(0.1,0.1);
	singleAsteroid.body.setRectangle(40,40);
	singleAsteroid.body.setCollisionGroup(asternoidCollisionGroup);
	singleAsteroid.body.collides([shipCollisionGroup,asternoidCollisionGroup]);
	singleAsteroid.body.damping = 0.0;
	singleAsteroid.body.thrust(500);*/
	var singleAsteroid = UFOs.create(body2.sprite.x,body2.sprite.y,'Asteroid');
	singleAsteroid.body.rotation = body2.sprite.rotation;
	singleAsteroid.body.velocity = body2.sprite.velocity;
	singleAsteroid.scale.setTo(0.1,0.1);
	singleAsteroid.body.setRectangle(40,40);
	singleAsteroid.body.setCollisionGroup(ufoCollisionGroup);
	singleAsteroid.body.collides([shipCollisionGroup,asternoidCollisionGroup]);
	singleAsteroid.body.damping = 0.0;
	singleAsteroid.body.thrust(500);
	body2.sprite.kill();
	}
</script>
</body>
</html>